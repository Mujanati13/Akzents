<section class="min-h-[calc(100vh-95px)] flex flex-col">
  <h2 translate class="flex justify-between items-center text-primary-700 mb-8 gap-6">
    <div class="flex gap-2">
      <app-icon name="users" class="w-8 flex items-center mr-1 text-primary-700" />
      <span class="text-[32px] font-bold font-dm">Benutzer bearbeiten</span>
    </div>
    <button
      type="button"
      class="cursor-pointer pr-6 flex items-center justify-center text-primary-600 hover:text-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      (click)="cancel()"
      [disabled]="isSubmitting"
      title="Zurück"
    >
      <app-icon name="arrow-left" class="w-6 h-6"></app-icon>
    </button>
  </h2>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="flex items-center justify-center py-8">
    <div class="flex items-center gap-2 text-gray-500">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"></div>
      <span>Lade Benutzerdaten...</span>
    </div>
  </div>

  <!-- User form -->
  <form *ngIf="!isLoading && currentUser" [formGroup]="userForm" (ngSubmit)="onSubmit()" class="flex-1" autocomplete="off">
    <p-tabs [value]="selectedTab" (onChange)="onTabChange($event)">
      <p-tablist>
        <p-tab [value]="0" class="w-[309px]" [disabled]="userType !== 'akzente'">Akzente</p-tab>
        <p-tab [value]="1" class="w-[309px]" [disabled]="userType !== 'client'">Kunde</p-tab>
      </p-tablist>
      <p-tabpanels>
        <!-- Akzente Tab Panel -->
        <p-tabpanel [value]="0">
          <div class="flex flex-col gap-y-6 mt-6">
            <div class="flex gap-x-2">
              <!-- Anrede -->
              <p-iftalabel>
                <p-dropdown id="salutation" formControlName="salutation" [options]="salutationOptions" optionLabel="name" optionValue="code" class="w-[123px] h-[60px]"></p-dropdown>
                <label for="salutation">Anrede <span class="text-red-500">*</span></label>
              </p-iftalabel>

              <!-- Vorname -->
              <p-iftalabel>
                <input pInputText id="firstName" formControlName="firstName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="firstName">Vorname <span class="text-red-500">*</span></label>
              </p-iftalabel>

              <!-- Name -->
              <p-iftalabel>
                <input pInputText id="lastName" formControlName="lastName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="lastName">Name <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>

            <div class="flex gap-x-2">
              <!-- Telefon -->
              <p-iftalabel>
                <input pInputText id="phone" formControlName="phone" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="phone">Telefon</label>
              </p-iftalabel>

              <!-- E-Mail -->
              <p-iftalabel>
                <input pInputText id="email" formControlName="email" autocomplete="new-email" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="email">E-Mail <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>

            <!-- Removed password input and only kept the reset button -->
            <div class="flex gap-x-2">
              <button
                type="button"
                (click)="generateNewPassword()"
                class="cursor-pointer px-3 py-4 bg-primary-500 text-white rounded-md font-dm text-[14px] w-[389px] hover:bg-primary-600 transition-colors"
              >
                Neues Passwort generieren und verschicken
              </button>
            </div>
          </div>

          <!-- Favoritisierte Kunden for Akzente -->
          <div class="mt-2" *ngIf="allClientCompanies.length > 0">
            <h3 class="text-[14px] font-bold text-primary-500 mb-2">Favoritisierte Kunden</h3>

            <!-- Dynamic client companies grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" formGroupName="companies">
              <div
                *ngFor="let company of allClientCompanies; let i = index; trackBy: trackByCompanyId"
                class="border border-[#DCDCDC] rounded-md p-3 flex items-center justify-between h-[60px] cursor-pointer transition-all duration-200 hover:shadow-md"
                [class.border-blue-600]="isCompanySelected(getControlName(company.name))"
                [class.shadow-selected]="isCompanySelected(getControlName(company.name))"
                [class.bg-blue-50]="isCompanySelected(getControlName(company.name))"
                (click)="toggleCompanySelection(getControlName(company.name))"
              >
                <!-- Company logo or fallback -->
                <img [src]="company.logo?.path || getFallbackImage(company.name)" [alt]="company.name" class="h-6 object-contain" (error)="$event.target.src = getFallbackImage(company.name)" />
                <div class="flex items-center gap-x-4">
                  <span class="text-sm font-medium">{{ company.name }}</span>
                  <p-checkbox [formControlName]="getControlName(company.name)" [binary]="true" [inputId]="'company_' + company.id + '_akzente'" (onClick)="$event.stopPropagation()"></p-checkbox>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>

        <!-- Client Tab Panel -->
        <p-tabpanel [value]="1">
          <div class="flex flex-col gap-y-6 mt-6">
            <div class="flex gap-x-2">
              <!-- Anrede -->
              <p-iftalabel>
                <p-dropdown id="salutation2" formControlName="salutation" [options]="salutationOptions" optionLabel="name" optionValue="code" class="w-[123px] h-[60px]"></p-dropdown>
                <label for="salutation2">Anrede <span class="text-red-500">*</span></label>
              </p-iftalabel>

              <!-- Vorname -->
              <p-iftalabel>
                <input pInputText id="firstName2" formControlName="firstName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="firstName2">Vorname <span class="text-red-500">*</span></label>
              </p-iftalabel>

              <!-- Name -->
              <p-iftalabel>
                <input pInputText id="lastName2" formControlName="lastName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="lastName2">Name <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>

            <div class="flex gap-x-2">
              <!-- Telefon -->
              <p-iftalabel>
                <input pInputText id="phone2" formControlName="phone" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="phone2">Telefon <span class="text-red-500">*</span></label>
              </p-iftalabel>

              <!-- E-Mail -->
              <p-iftalabel>
                <input pInputText id="email2" formControlName="email" autocomplete="new-email" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="email2">E-Mail <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>

            <!-- Removed password input and only kept the reset button -->
            <div class="flex gap-x-2">
              <button
                type="button"
                (click)="generateNewPassword()"
                class="cursor-pointer px-3 py-1 bg-primary-500 text-white rounded-md font-dm text-[14px] w-[389px] hover:bg-primary-600 transition-colors"
              >
                Neues Passwort generieren und verschicken
              </button>
            </div>
          </div>

          <!-- Zuordnung Kunden for Client -->
          <div class="mt-2" *ngIf="allClientCompanies.length > 0">
            <h3 class="text-[14px] font-bold text-primary-500 mb-2">Zuordnung Kunden</h3>

            <!-- Dynamic client companies grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" formGroupName="companies">
              <div
                *ngFor="let company of allClientCompanies; let i = index; trackBy: trackByCompanyId"
                class="border border-[#DCDCDC] rounded-md p-3 flex items-center justify-between h-[60px] cursor-pointer transition-all duration-200 hover:shadow-md"
                [class.border-blue-600]="isCompanySelected(getControlName(company.name))"
                [class.shadow-selected]="isCompanySelected(getControlName(company.name))"
                [class.bg-blue-50]="isCompanySelected(getControlName(company.name))"
                (click)="toggleCompanySelection(getControlName(company.name))"
              >
                <!-- Company logo or fallback -->
                <img [src]="company.logo?.path || getFallbackImage(company.name)" [alt]="company.name" class="h-6 object-contain" (error)="$event.target.src = getFallbackImage(company.name)" />
                <div class="flex items-center gap-x-4">
                  <span class="text-sm font-medium">{{ company.name }}</span>
                  <p-checkbox [formControlName]="getControlName(company.name)" [binary]="true" [inputId]="'company_' + company.id + '_client'" (onClick)="$event.stopPropagation()"></p-checkbox>
                </div>
              </div>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>

    <!-- Empty state for companies -->
    <div *ngIf="!isLoading && allClientCompanies.length === 0" class="mt-8 text-center py-8 text-gray-500">
      <p>Keine Kundenunternehmen verfügbar.</p>
    </div>
  </form>

  <!-- Error state -->
  <div *ngIf="!isLoading && !currentUser" class="flex items-center justify-center py-8">
    <div class="text-center">
      <p class="text-gray-500 text-lg mb-4">Benutzer nicht gefunden</p>
      <button (click)="cancel()" class="px-4 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 transition-colors">Zurück zur Übersicht</button>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="sticky bottom-0 bg-white py-4 pl-6 z-10" *ngIf="!isLoading && currentUser">
    <div class="flex justify-end gap-4">
      <button
        type="button"
        (click)="cancel()"
        class="py-2 bg-white border border-primary-500 text-primary-500 font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 hover:bg-primary-50 h-[49px] w-[150px]"
      >
        <span>Schließen</span>
      </button>
      <button
        type="button"
        (click)="onSubmit()"
        [disabled]="!isFormValidForSubmission() || isSubmitting"
        class="py-2 bg-primary-500 hover:bg-primary-700 text-white font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed h-[49px] w-[200px]"
      >
        <span *ngIf="!isSubmitting">Änderungen speichern</span>
        <span *ngIf="isSubmitting" class="flex items-center justify-center">
          <i class="pi pi-spin pi-spinner mr-2"></i>
          Speichere...
        </span>
      </button>
    </div>
  </div>
</section>
