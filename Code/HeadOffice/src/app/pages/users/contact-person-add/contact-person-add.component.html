<section class="min-h-[calc(100vh-95px)] flex flex-col">
  <h2 translate class="flex justify-between items-center text-primary-700 mb-8 gap-6">
    <div class="flex gap-2">
      <app-icon name="users" class="w-8 flex items-center mr-1 text-primary-700" />
      <span class="text-[32px] font-bold font-dm">Benutzer</span>
    </div>
    <button
      type="button"
      class="cursor-pointer pr-6 flex items-center justify-center text-primary-600 hover:text-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      (click)="cancel()"
      title="Zurück"
    >
      <app-icon name="arrow-left" class="w-6 h-6"></app-icon>
    </button>
  </h2>
  <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="flex-1">
    <p-tabs [value]="0">
      <p-tablist>
        <p-tab [value]="0" class="w-[309px]">Neuer Ansprechpartner</p-tab>
      </p-tablist>
      <p-tabpanels>
        <p-tabpanel [value]="0">
          <div class="flex flex-col gap-y-6 mt-6">
            <div class="flex gap-x-2">
              <!-- Anrede -->
              <p-iftalabel>
                <p-dropdown id="gender" formControlName="gender" [options]="genderOptions" optionLabel="name" optionValue="code" class="w-[123px] h-[60px]"></p-dropdown>
                <label for="gender">Anrede <span class="text-red-500">*</span></label>
              </p-iftalabel>
              <!-- Vorname -->
              <p-iftalabel>
                <input pInputText id="firstName" formControlName="firstName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="firstName">Vorname <span class="text-red-500">*</span></label>
              </p-iftalabel>
              <!-- Name -->
              <p-iftalabel>
                <input pInputText id="lastName" formControlName="lastName" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="lastName">Name <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>
            <div class="flex gap-x-2">
              <!-- Telefon -->
              <p-iftalabel>
                <input pInputText id="phone" formControlName="phone" autocomplete="off" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="phone">Telefon</label>
              </p-iftalabel>
              <!-- E-Mail -->
              <p-iftalabel>
                <input pInputText id="email" formControlName="email" autocomplete="new-email" class="w-[337px] h-[60px] pr-10 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
                <label for="email">E-Mail <span class="text-red-500">*</span></label>
              </p-iftalabel>
            </div>
        
          </div>

          <!-- Zuordnung Kunden -->
          <div class="mt-2">
            <h3 class="text-[14px] font-bold text-primary-500 mb-2">Zuordnung Kunden</h3>

            <!-- Loading state -->
            <div *ngIf="isLoadingClient" class="flex items-center gap-2 text-gray-500 mb-4">
              <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-primary-500"></div>
              <span>Lade Kundenunternehmen...</span>
            </div>

            <!-- Preselected client display -->
            <div *ngIf="!isLoadingClient && preSelectedClient" class="grid grid-cols-4 gap-4" formGroupName="customers">
              <div class="border border-blue-600 shadow-selected rounded-md p-3 flex items-center justify-between h-[60px] cursor-not-allowed pointer-events-none">
                <!-- Company logo or fallback -->
                <img
                  [src]="preSelectedClient.logo?.path || getFallbackImage(preSelectedClient.name)"
                  [alt]="preSelectedClient.name"
                  class="h-6 object-contain"
                  (error)="$event.target.src = getFallbackImage(preSelectedClient.name)"
                />
                <div class="flex items-center gap-x-4">
                  <span>{{ preSelectedClient.name }}</span>
                  <p-checkbox [formControlName]="getControlName(preSelectedClient.name)" [binary]="true" [inputId]="'company_' + preSelectedClient.id" [disabled]="true"> </p-checkbox>
                </div>
              </div>
            </div>

            <!-- No client selected state -->
            <div *ngIf="!isLoadingClient && !preSelectedClient" class="py-4 px-4 bg-gray-50 rounded-md text-gray-600 border border-gray-200">
              <p class="text-sm">Kein Kundenunternehmen zugeordnet. Der Ansprechpartner kann später einem Kunden zugewiesen werden.</p>
            </div>
          </div>
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  </form>
  <div class="sticky bottom-0 bg-white py-4 pl-6 z-10">
    <div class="flex justify-end gap-4">
      <button
        type="button"
        (click)="cancel()"
        class="py-2 bg-white border border-primary-500 text-primary-500 font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 hover:bg-primary-50 h-[49px] w-[150px]"
      >
        Schließen
      </button>
      <button
        type="button"
        (click)="onSubmit()"
        [disabled]="!isFormValidForSubmission() || isSubmitting"
        class="py-2 bg-primary-500 hover:bg-primary-700 text-white font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed h-[49px] w-[311px]"
      >
        <span *ngIf="!isSubmitting">Benutzer anlegen und Passwort verschicken</span>
        <span *ngIf="isSubmitting" class="flex items-center justify-center">
          <i class="pi pi-spin pi-spinner mr-2"></i>
          Erstelle Ansprechpartner...
        </span>
      </button>
    </div>
  </div>
</section>
