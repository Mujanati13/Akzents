<section class="min-h-[calc(100vh-95px)] flex flex-col">
  <div class="flex-1">
    <h2 translate class="flex justify-between items-center text-primary-700 mb-8 gap-6">
      <div class="flex gap-2">
        <app-icon name="clients" class="w-9 flex items-center mr-1 text-primary-700" />
        <span class="text-[32px] font-bold font-dm">Kunden bearbeiten</span>
      </div>
      <button
        type="button"
        class="cursor-pointer pr-6 flex items-center justify-center text-primary-600 hover:text-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        (click)="cancel()"
        title="Zurück"
      >
        <app-icon name="arrow-left" class="w-6 h-6"></app-icon>
      </button>
    </h2>

    <!-- Loading state -->
    <div *ngIf="isLoading" class="flex place-self-center items-center gap-2 text-gray-500 mb-4">
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500"></div>
      <span>Lade Kundendaten...</span>
    </div>

    <form [formGroup]="clientForm" (ngSubmit)="onSubmit()" class="flex-1" *ngIf="!isLoading">
      <!-- Client Name with PrimeNG floating label -->
      <div class="mb-8">
        <p-floatlabel variant="in">
          <input pInputText id="name" formControlName="name" autocomplete="off" class="w-[339px] pr-10 py-3 border border-gray-300 focus:outline-none text-gray-700 bg-white" />
          <label for="name">Kundenname</label>
        </p-floatlabel>
      </div>

      <!-- Logo Upload section -->
      <div class="mb-8">
        <app-image-upload label="Logo" [imagePreview]="logoPreview" [fileName]="fileName" (fileSelected)="onImageSelected($event)" (fileRemoved)="onImageRemoved()"> </app-image-upload>
      </div>

      <!-- Ansprechpartner Kunde (Contact Persons) -->
      <div class="mb-8">
        <label class="block text-[14px] font-bold text-primary-500 mb-2">
          Ansprechpartner Kunde
          <span class="text-gray-400 font-normal ml-2">({{ clientUsers.length }} verfügbar)</span>
        </label>

        <!-- PrimeNG Autocomplete with multiple selection -->
        <div class="flex gap-x-2 items-end">
          <p-autocomplete
            [(ngModel)]="contactValue"
            [ngModelOptions]="{ standalone: true }"
            [suggestions]="filteredContacts"
            [dropdown]="true"
            (completeMethod)="searchContacts($event)"
            (onSelect)="onContactsChanged()"
            (onUnselect)="onContactsChanged()"
            (onChange)="onContactsChanged()"
            [multiple]="true"
            placeholder="Kontakte suchen"
            [styleClass]="'w-[339px] min-h-[46px]'"
          ></p-autocomplete>

          <button type="button" (click)="addCustomContact()" class="cursor-pointer px-3 py-1 bg-primary-500 text-white rounded-md font-dm text-[14px] h-[46px] w-[245px]">Neuen Ansprechpartner anlegen</button>
        </div>
      </div>

      <!-- Projektleiter Akzente (Project Managers) -->
      <div class="mb-12">
        <label class="block text-[14px] font-bold text-primary-500 mb-2">
          Projektleiter Akzente
          <span class="text-gray-400 font-normal ml-2">({{ akzenteUsers.length }} verfügbar)</span>
        </label>

        <p-autocomplete
          [(ngModel)]="selectedManagers"
          [ngModelOptions]="{ standalone: true }"
          [dropdown]="true"
          [suggestions]="filteredManagers"
          (completeMethod)="searchManagers($event)"
          (onSelect)="onManagersChanged()"
          (onUnselect)="onManagersChanged()"
          (onChange)="onManagersChanged()"
          [multiple]="true"
          placeholder="Projektleiter suchen"
          [styleClass]="'w-[339px] min-h-[46px]'"
        ></p-autocomplete>
      </div>
    </form>
  </div>

  <div class="sticky bottom-0 bg-white py-4 pl-6 z-10" *ngIf="!isLoading">
    <div class="flex justify-end gap-4">
      <button
        type="button"
        (click)="cancel()"
        class="py-2 bg-white border border-primary-500 text-primary-500 font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 hover:bg-primary-50 h-[49px] w-[150px]"
      >
        Schließen
      </button>
      <button
        type="button"
        (click)="onSubmit()"
        [disabled]="clientForm?.invalid || isSubmitting"
        class="px-4 py-2 bg-primary-500 hover:bg-primary-700 text-white font-dm cursor-pointer text-[14px] rounded-md transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed h-[49px] w-[200px]"
      >
        <span *ngIf="!isSubmitting">Änderungen speichern</span>
        <span *ngIf="isSubmitting" class="flex items-center justify-center">
          <i class="pi pi-spin pi-spinner mr-2"></i>
          Speichere...
        </span>
      </button>
    </div>
  </div>
</section>
