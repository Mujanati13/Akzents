<section *ngIf="client; else notFound">
  <!-- Loading indicator for whole page -->
  <div *ngIf="isLoading" class="flex justify-center items-center min-h-[400px]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
      <p class="text-gray-600 text-lg">Lade Projekte...</p>
    </div>
  </div>

  <!-- Page content (only show when not loading) -->
  <div *ngIf="!isLoading">
  <h2 translate class="flex text-primary-700 mb-10">
    <app-icon name="projects" class="w-8 flex items-center mr-1 text-primary-700" />
    <span class="text-[32px] font-bold font-dm">
      Projekte<span *ngIf="statusFilter"> ({{ getStatusFilterDisplayName() }})</span>
    </span>
  </h2>
  <div class="mb-8 grid grid-cols-1 lg:grid-cols-[285px_285px_285px_285px_auto] gap-[15px] items-center">
    <!-- Search Input for Projects -->
    <div class="relative w-full lg:w-[285px]">
      <input
        type="text"
        placeholder="Projektsuche"
        [(ngModel)]="projectSearchTerm"
        (input)="onProjectSearch($event)"
        class="h-[54px] px-4 pr-10 border border-gray-300 rounded-md font-inter text-sm w-full focus:outline-none focus:ring-0 focus:border-primary-500"
      />
      <app-icon name="search" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-[19px] h-[19px] text-gray-500" />
    </div>

    <!-- Search Input for Filialen -->
    <div class="relative w-full lg:w-[285px]">
      <input
        type="text"
        placeholder="Filialesuche"
        [(ngModel)]="filialeSearchTerm"
        (input)="onFilialeSearch($event)"
        class="h-[54px] px-4 pr-10 border border-gray-300 rounded-md font-inter text-sm w-full focus:outline-none focus:ring-0 focus:border-primary-500"
      />
      <app-icon name="search" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-[19px] h-[19px] text-gray-500" />
    </div>

    <!-- Date Picker with Custom Popover -->
    <app-date-range-picker [(selectedRange)]="dateRange2" (rangeSelected)="onRangeSelected($event)" position="right"></app-date-range-picker>

    <!-- Clear Filters Button -->
    <div class="flex gap-2">
      <button
        *ngIf="projectSearchTerm || filialeSearchTerm || dateRange2.start || dateRange2.end || hasProjectColumnFilters() || statusFilter || hasReportColumnFilters()"
        (click)="clearFilters()"
        class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors text-sm cursor-pointer"
      >
        Alle anzeigen
      </button>
    </div>
  </div>

  <p-table
    [value]="filteredProjects"
    stripedRows
    [scrollable]="true"
    scrollHeight="78vh"
    dataKey="id"
    [tableStyle]="{ 'min-width': '60rem', 'max-width': '100%' }"
    [expandedRowKeys]="expandedRows"
    (onRowExpand)="onRowExpand($event)"
    (onRowCollapse)="onRowCollapse($event)"
    [columns]="getProjectsVisibleColumns()"
    [reorderableColumns]="true"
    (onColReorder)="onProjectsColReorder($event)"
  >
    <ng-template #header let-columns>
      <tr>
        <th class="rounded-l-lg">
          <div class="flex gap-x-2 items-center">
            <div class="flex space-x-2 items-center">
              <span>Projekt</span>
              <app-icon name="table_sort" 
                [class.text-primary-500]="projectSortField === 'name'"
                [class.text-white]="projectSortField !== 'name'"
                class="w-3 cursor-pointer" 
                (click)="onProjectSort('name', $event)" />
            </div>
            <div class="items-center cursor-pointer text-xs" (click)="openProjectColumnFilter('name', $event)">
              <svg class="w-3 h-3"
                [class.text-green-500]="getProjectColumnFilterValue('name') && getProjectColumnFilterValue('name').length > 0"
                [class.text-white]="!getProjectColumnFilterValue('name') || getProjectColumnFilterValue('name').length === 0"
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
            </div>
          </div>
        </th>
        <th *ngFor="let col of columns" pReorderableColumn>
          <div class="flex gap-x-2 items-center">
            <div class="flex space-x-2 items-center">
              <span>{{ col.header }}</span>
              <app-icon name="table_sort" 
                [class.text-primary-500]="projectSortField === col.field"
                [class.text-white]="projectSortField !== col.field"
                class="w-3 cursor-pointer" 
                (click)="onProjectSort(col.field, $event)" />
            </div>
            <div class="items-center cursor-pointer text-xs" (click)="openProjectColumnFilter(col.field, $event)">
              <svg class="w-3 h-3"
                [class.text-green-500]="getProjectColumnFilterValue(col.field) && getProjectColumnFilterValue(col.field).length > 0"
                [class.text-white]="!getProjectColumnFilterValue(col.field) || getProjectColumnFilterValue(col.field).length === 0"
                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
            </div>
          </div>
        </th>
        <th class="rounded-r-lg">
          <div class="flex space-x-2 items-center justify-end cursor-pointer">
            <span (click)="toggleProjectSettingsPopover($event)"> Settings</span> <span class="pi pi-cog text-sm!" (click)="toggleProjectSettingsPopover($event)"></span>
          </div>
        </th>
      </tr>
    </ng-template>
    <ng-template #body let-project let-expanded="expanded" let-columns="columns">
      <tr>
        <td [pRowToggler]="project" class="cursor-pointer rounded-l-lg font-bold text-primary-500" (click)="expanded ? collapseProject() : selectProject(project)">{{ project.name }}</td>
        <td *ngFor="let col of columns">
          <ng-container [ngSwitch]="col.field">
            <!-- Special formatting for zeitraum -->
            <ng-container *ngSwitchCase="'formattedZeitraum'">
              <span
                ><strong>{{ project.calendarWeek }}</strong> {{ project.zeitraum }}</span
              >
            </ng-container>

            <!-- Special formatting for filialen -->
            <ng-container *ngSwitchCase="'filialen'"> {{ project.branchesCount }} Stores </ng-container>

            <!-- Special formatting for status as percentage -->
            <ng-container *ngSwitchCase="'status'">
              <span>{{ project.reportedPercentage ?? 0 }}% reported</span>
            </ng-container>

            <!-- Default formatting for other columns -->
            <ng-container *ngSwitchDefault>
              {{ project[col.field] }}
            </ng-container>
          </ng-container>
        </td>
        <td class="rounded-r-lg">
          <div class="flex space-x-3 justify-end">
            <app-icon name="paper_search" class="h-4 w-4 cursor-pointer text-blue-600" title="Download Excel" (click)="downloadProjectCsv(project)" />
            <app-favorite-toggle class="h-5 w-5 flex-shrink-0" [isFavorite]="project.isFavorite" (favoriteChange)="onFavoriteChanged($event, project)" />
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template #expandedrow let-project>
      <tr>
        <td colspan="7" class="bg-gray-50 px-2!">
          <!-- Loading indicator -->
          <div *ngIf="loadingReports[project.id] || loadingReports[project.id?.toString()]" class="flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
            <span class="ml-2 text-gray-600">Lade Aufträge...</span>
          </div>

          <!-- Reports table (only show when not loading and reports exist) -->
          <div class="reports-table-wrapper" style="display: block;overflow-x: auto;">
            <p-table *ngIf="(!loadingReports[project.id] && !loadingReports[project.id?.toString()]) || filteredReports(project).length > 0"
              [value]="filteredReports(project)" dataKey="id" [columns]="getReportsVisibleColumns()"
              [reorderableColumns]="true" (onColReorder)="onReportsColReorder($event)"
              [scrollable]="true" scrollHeight="300px" scrollWidth="95rem" [tableStyle]="{ 'min-width': '100%' }">
            <ng-template #header let-columns>
              <tr>
                <th class="rounded-l-lg">
                  <div class="flex gap-x-2 items-center">
                    <div class="flex space-x-2 items-center">
                      <span>Status</span>
                      <app-icon name="table_sort" 
                        [class.text-primary-500]="reportSortField === 'status'"
                        [class.text-white]="reportSortField !== 'status'"
                        class="w-3 cursor-pointer" 
                        (click)="onReportSort('status', project, $event)" />
                    </div>
                    <div class="items-center cursor-pointer text-xs" (click)="openStatusFilter($event); $event.stopPropagation()">
                      <svg 
                        class="w-3 h-3"
                        [class.text-green-500]="reportStatusFilter && reportStatusFilter.length > 0"
                        [class.text-white]="!reportStatusFilter || reportStatusFilter.length === 0"
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                      </svg>
                    </div>
                  </div>
                </th>
                <th *ngFor="let col of columns" pReorderableColumn>
                  <div class="flex items-center relative">
                    <div class="flex space-x-2 items-center">
                      <span 
                        [class.cursor-pointer]="col.field === 'plannedOn'"
                        (click)="col.field === 'plannedOn' ? onPlannedOnColumnClick($event) : null"
                        [title]="col.field === 'plannedOn' ? 'Datum auswählen' : ''">{{ col.header }}</span>
                      <app-icon name="table_sort" 
                        [class.text-primary-500]="reportSortField === col.field"
                        [class.text-white]="reportSortField !== col.field"
                        class="w-3 cursor-pointer" 
                        (click)="onReportSort(col.field, project, $event); $event.stopPropagation()" />
                      <!-- PlannedOn Date Filter Icon -->
                      <div *ngIf="col.field === 'plannedOn'" class="items-center cursor-pointer text-xs"
                        (click)="openPlannedOnFilter($event); $event.stopPropagation()">
                        <svg class="w-3 h-3"
                          [class.text-green-500]="reportPlannedOnFilter && reportPlannedOnFilter.length > 0"
                          [class.text-white]="!reportPlannedOnFilter || reportPlannedOnFilter.length === 0"
                          fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                      </div>

                      <!-- Merchandiser Filter Icon -->
                      <div *ngIf="col.field === 'merchandiser'" class="items-center cursor-pointer text-xs" (click)="openMerchandiserFilter($event); $event.stopPropagation()">
                        <svg 
                          class="w-3 h-3"
                          [class.text-green-500]="reportMerchandiserFilter && reportMerchandiserFilter.length > 0"
                          [class.text-white]="!reportMerchandiserFilter || reportMerchandiserFilter.length === 0"
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                      </div>
                      
                      <!-- Filialen Filter Icon -->
                      <div *ngIf="col.field === 'branch.name'" class="items-center cursor-pointer text-xs" (click)="openFilialenFilter($event); $event.stopPropagation()">
                        <svg 
                          class="w-3 h-3"
                          [class.text-green-500]="reportFilialenFilter && reportFilialenFilter.length > 0"
                          [class.text-white]="!reportFilialenFilter || reportFilialenFilter.length === 0"
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                      </div>

                      <!-- Generic Filter Icon for all other columns -->
                      <div *ngIf="col.field !== 'merchandiser' && col.field !== 'branch.name' && col.field !== 'plannedOn'"
                        class="items-center cursor-pointer text-xs"
                        (click)="openGenericFilter(col.field, $event); $event.stopPropagation()">
                        <svg class="w-3 h-3"
                          [class.text-green-500]="getGenericFilterValue(col.field) && getGenericFilterValue(col.field).length > 0"
                          [class.text-white]="!getGenericFilterValue(col.field) || getGenericFilterValue(col.field).length === 0"
                          fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                      </div>
                    </div>
                  </div>
                </th>
                <th class="rounded-r-lg">
                  <div class="flex space-x-2 items-center justify-end cursor-pointer">
                    <span (click)="toggleReportSettingsPopover($event)"> Settings</span> <span class="pi pi-cog text-sm!" (click)="toggleReportSettingsPopover($event)"></span>
                  </div>
                </th>
              </tr>
            </ng-template>
            <ng-template #body let-report let-columns="columns">
              <tr class="bg-white">
                <td class="rounded-l-lg">
                  <span *ngIf="report?.status" class="text-white w-[70px] h-[23px] uppercase text-xs rounded-sm flex items-center justify-center" [style.background-color]="report.status?.color">
                    {{ report.status?.name }}
                  </span>
                </td>
                <td *ngFor="let col of columns">
                  <ng-container [ngSwitch]="col.field">
                    <!-- Handle special rendering for isSpecCompliant field -->
                    <ng-container *ngSwitchCase="'plannedOn'">
                      <ng-container *ngIf="report.plannedOn && report.plannedOn.trim().length > 0 && editingPlannedOnReportId !== report.id; else editPlannedOn">
                        {{ report.plannedOn | euDate }}
                      </ng-container>
                      <ng-template #editPlannedOn>
                        <div *ngIf="editingPlannedOnReportId === report.id; else pencilBlock" class="flex items-center gap-2">
                          <input type="date" [value]="report.plannedOn || ''" (change)="onPlannedOnDateChange(report, $event)" class="border rounded border-primary-500 px-2 py-1" />
                          <app-icon name="save" class="w-4 h-4 text-primary-500 cursor-pointer rounded transition" (click)="savePlannedOnEdit(report)" title="Save" />
                        </div>
                      </ng-template>
                      <ng-template #pencilBlock>
                        <div class="text-center">
                          <app-icon name="pencil_square" class="w-5 h-5 text-primary-500 cursor-pointer" (click)="startEditingPlannedOn(report)" />
                        </div>
                      </ng-template>
                    </ng-container>
                    <ng-container *ngSwitchCase="'reportTo'">
                      {{ report.reportTo | euDate }}
                    </ng-container>
                    <ng-container *ngSwitchCase="'feedback'">
                      {{ report.feedback === true || report.feedback === 'true' ? 'Ja' : '' }}
                    </ng-container>
                    <ng-container *ngSwitchCase="'isSpecCompliant'">
                      {{ report.isSpecCompliant ? 'Ja' : '' }}
                    </ng-container>
                    <ng-container *ngSwitchCase="'merchandiser'">
                      {{ getReportMerchandiserName(report) }}
                    </ng-container>
                    <ng-container *ngSwitchCase="'branch.name'">
                      {{ report.branch?.name }}
                    </ng-container>
                    <ng-container *ngSwitchCase="'address'">
                      {{ getReportAddress(report) }}
                    </ng-container>
                    <!-- Default rendering for other fields -->
                    <ng-container *ngSwitchDefault>
                      {{ report[col.field] }}
                    </ng-container>
                  </ng-container>
                </td>
                <td class="rounded-r-lg">
                  <div class="flex space-x-3 justify-end">
                    <a
                      [routerLink]="['/clients', report.clientCompany?.id, 'projects', report.project?.id, 'edit-report', report.id]"
                      class="flex items-center cursor-pointer"
                      title="Bearbeiten (Rechtsklick für neuen Tab)"
                      (click)="$event.stopPropagation()"
                    >
                      <app-icon
                        name="pencil"
                        class="w-5 h-5 cursor-pointer text-primary-500"
                        title="Bearbeiten (Rechtsklick für neuen Tab)"
                      />
                    </a>
                    <a
                      [routerLink]="['/clients', report.clientCompany?.id, 'projects', report.project?.id, 'reports', report.id]"
                      class="flex items-center cursor-pointer"
                      title="Anzeigen (Rechtsklick für neuen Tab)"
                      (click)="$event.stopPropagation()"
                    >
                      <app-icon
                        name="resizeable_eye"
                        class="w-5 h-5 flex items-center cursor-pointer text-primary-500"
                        title="Anzeigen (Rechtsklick für neuen Tab)"
                      />
                    </a>
                    <app-favorite-toggle class="h-5 w-5 flex-shrink-0" [isFavorite]="report.isFavorite" (favoriteChange)="onReportFavoriteChanged($event, report)" />
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template #emptymessage>
              <tr *ngIf="!loadingReports[project.id]">
                <td colspan="10" class="bg-white">Es sind noch keine Aufträge für dieses Projekt vorhanden.</td>
              </tr>
            </ng-template>
          </p-table>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <p-popover #op>
    <div class="flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <span class="font-semibold text-sm">Column Settings</span>
        <button type="button" (click)="op.hide(); $event.stopPropagation()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p-multiselect
        display="chip"
        [options]="cols"
        [(ngModel)]="selectedColumns"
        (onChange)="onProjectsColumnsChange($event.value)"
        optionLabel="header"
        selectedItemsLabel="{0} columns selected"
        [style]="{ 'min-width': '200px' }"
        placeholder="Choose Columns"
      />
    </div>
  </p-popover>

  <!-- Project Column Filter Popover -->
  <p-popover #projectColumnFilterPopover>
    <div class="flex flex-col">
      <div class="flex items-center justify-between mb-2">
        <span class="font-semibold text-sm">Filter</span>
        <button type="button" (click)="projectColumnFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p-multiselect
        display="chip"
        [(ngModel)]="projectColumnFilters[currentProjectFilterField]"
        [options]="getProjectFilterOptions(currentProjectFilterField)"
        [placeholder]="getProjectFilterPlaceholder(currentProjectFilterField)"
        [showClear]="true"
        [style]="{ 'min-width': '200px' }"
        selectedItemsLabel="{0} ausgewählt"
        (onChange)="applyFilters()"
      />
    </div>
  </p-popover>
  </div>
</section>

<ng-template #notFound>
  <div class="flex justify-center items-center min-h-[400px]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
      <p class="text-gray-600 text-lg">Lade Kunde...</p>
    </div>
  </div>
</ng-template>

<!-- Add this at the bottom of your component, after the existing popover -->
<p-popover #reportColumnsPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Column Settings</span>
      <button type="button" (click)="reportColumnsPopover.hide(); $event.stopPropagation()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect
      display="chip"
      [options]="reportCols"
      [(ngModel)]="selectedReportColumns"
      (onChange)="onReportsColumnsChange($event.value)"
      optionLabel="header"
      selectedItemsLabel="{0} columns selected"
      [style]="{ 'min-width': '200px' }"
      placeholder="Choose Columns"
    />
  </div>
</p-popover>

<!-- Status Filter Popover -->
<p-popover #statusFilterPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Filter</span>
      <button type="button" (click)="statusFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect
      display="chip"
      [(ngModel)]="reportStatusFilter"
      [options]="getUniqueReportStatuses()"
      optionLabel="name"
      optionValue="name"
      placeholder="Alle Status"
      [showClear]="true"
      [style]="{ 'min-width': '200px' }"
      selectedItemsLabel="{0} Status ausgewählt"
    >
      <ng-template let-status pTemplate="item">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full" [style.background-color]="status.color"></span>
          <span>{{ status.name }}</span>
        </div>
      </ng-template>
    </p-multiselect>
  </div>
</p-popover>

<!-- Merchandiser Filter Popover -->
<p-popover #merchandiserFilterPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Filter</span>
      <button type="button" (click)="merchandiserFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect
      display="chip"
      [(ngModel)]="reportMerchandiserFilter"
      [options]="getUniqueMerchandisers()"
      placeholder="Alle Merchandiser"
      [showClear]="true"
      [style]="{ 'min-width': '200px' }"
      selectedItemsLabel="{0} Merchandiser ausgewählt"
    >
    </p-multiselect>
  </div>
</p-popover>

<!-- Filialen Filter Popover -->
<p-popover #filialenFilterPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Filter</span>
      <button type="button" (click)="filialenFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect
      display="chip"
      [(ngModel)]="reportFilialenFilter"
      [options]="getUniqueFilialen()"
      placeholder="Alle Filialen"
      [showClear]="true"
      [style]="{ 'min-width': '200px' }"
      selectedItemsLabel="{0} Filialen ausgewählt"
    >
    </p-multiselect>
  </div>
</p-popover>

<!-- PlannedOn Date Filter Popover -->
<p-popover #plannedOnFilterPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Filter</span>
      <button type="button" (click)="plannedOnFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect display="chip" [(ngModel)]="reportPlannedOnFilter" [options]="getUniquePlannedOnDates()"
      placeholder="Alle Daten" [showClear]="true" [style]="{ 'min-width': '200px' }"
      selectedItemsLabel="{0} Daten ausgewählt">
    </p-multiselect>
  </div>
</p-popover>

<!-- Generic Filter Popover -->
<p-popover #genericFilterPopover>
  <div class="flex flex-col">
    <div class="flex items-center justify-between mb-2">
      <span class="font-semibold text-sm">Filter</span>
      <button type="button" (click)="genericFilterPopover.hide()" class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <p-multiselect
      display="chip"
      [(ngModel)]="genericFilterValues[currentFilterField]"
      [options]="getUniqueValuesForField(currentFilterField)"
      [placeholder]="'Alle ' + getColumnHeader(currentFilterField)"
      [showClear]="true"
      [style]="{ 'min-width': '200px' }"
      selectedItemsLabel="{0} ausgewählt"
    >
    </p-multiselect>
  </div>
</p-popover>
