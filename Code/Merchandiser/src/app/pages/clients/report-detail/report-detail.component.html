<section>
  <!-- Loading state -->
  <div *ngIf="loading" class="flex justify-center items-center min-h-[400px]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"></div>
      <p class="text-gray-600 text-lg">Lade Bericht...</p>
    </div>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="bg-red-50 p-4 rounded-md">
    <p class="text-red-800">Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.</p>
  </div>

  <!-- Report details -->
  <div *ngIf="!loading && !error && report">
    <h2 translate class="flex justify-between items-center text-primary-700 mb-10 gap-6">
      <div class="flex gap-2">
        <app-icon name="projects" class="w-8 h-8 flex-shrink-0 text-primary-700" />
        <span class="text-[32px] font-bold font-dm leading-tight">Projekte</span>
      </div>
      <button
        type="button"
        class="cursor-pointer pr-6 flex items-center justify-center text-primary-600 hover:text-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        (click)="goBack()"
        title="Zurück"
      >
        <app-icon name="arrow-left" class="w-6 h-6"></app-icon>
      </button>
    </h2>
    <!-- Project Header -->
    <div class="bg-[#187DA4] rounded-[25px] text-white py-[15px] px-[20px] md:px-[37px] mb-6">
      <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center font-dm gap-4 lg:gap-0">
        <div class="flex-1">
          <div>
            <h2 class="text-[24px] md:text-[34px] font-bold leading-none">{{ report.project?.name || '' }}</h2>
            <p class="text-[13px] md:text-[15px]">{{ report.project?.startDate | euDate }} - {{ report.project?.endDate | euDate }}</p>
            <div
              class="mt-2 text-white uppercase text-[12px] md:text-[14px] font-extrabold py-0.25 px-3 rounded-[4px] inline-block uppercase min-w-[70px] text-center"
              [style.background-color]="report.status?.color"
            >
              {{ report.status?.name }}
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-4 sm:gap-x-[75px] mt-4">
            <div class="text-[13px] md:text-[15px]">
              <p class="font-extrabold">{{ report.branch?.name || '' }}</p>
              <p>
                {{ report?.street || '' }},<br />
                {{ report?.zipCode || '' }} <span *ngIf="report.branch?.city"> {{ report.branch.city.name }}</span>
              </p>
            </div>
            <div class="flex gap-x-[10px]">
              <div class="text-[13px] md:text-[15px]">
                <p>Merchandiser:</p>
                <p>Datum:</p>
              </div>
              <div class="text-[13px] md:text-[15px]">
                <p>{{ report.merchandiser?.user?.firstName || '' }} {{ report.merchandiser?.user?.lastName || '' }}</p>
                <p>{{ report.plannedOn | euDate }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="flex flex-row lg:flex-col h-auto lg:h-[130px] justify-between lg:justify-between items-center gap-4 lg:gap-0">
          <div class="flex flex-col items-center">
            <div class="toggle-container rounded-[10px] overflow-hidden flex">
              <button 
                class="toggle-option py-1 px-2 md:px-3 text-[12px] md:text-[14px] font-bold uppercase" 
                [class.active]="isStatusOpen()" 
                [disabled]="isReportClosed()"
                (click)="updateStatus('UngeprüfT')">
                UngeprüfT
              </button>
              <button 
                class="toggle-option py-1 px-2 md:px-3 text-[12px] md:text-[14px] font-bold uppercase" 
                [class.active]="!isStatusOpen()" 
                [disabled]="isReportClosed()"
                (click)="updateStatus('Freigegeben')">
                Freigegeben
              </button>
            </div>
            <span class="mt-1 uppercase font-dm text-[9px] md:text-[11px]">STATUS</span>
          </div>
          <div class="flex gap-x-[12px] md:gap-x-[16px] uppercase font-dm text-[8px] md:text-[10px]">
            <div class="flex flex-col items-center">
              <div
                class="bg-white w-[32px] h-[32px] md:w-[36px] md:h-[36px] rounded-full p-2 mb-1 flex items-center justify-center cursor-pointer"
                [routerLink]="['/clients', clientId, 'projects', projectId, 'edit-report', reportId]"
              >
                <app-icon name="pencil" class="w-[16px] h-[16px] md:w-[19px] md:h-[19px] cursor-pointer text-primary-800" title="Bearbeiten" />
              </div>
              <span class="mt-1">Bearbeiten</span>
            </div>
            <div class="flex flex-col items-center">
              <div class="bg-white w-[32px] h-[32px] md:w-[36px] md:h-[36px] rounded-full p-2 mb-1 flex items-center justify-center cursor-pointer">
                <app-favorite-toggle
                  class="h-4 w-4 md:h-5 md:w-5 flex-shrink-0"
                  activeColor="primary-500"
                  inactiveColor="primary-800"
                  [isFavorite]="report.isFavorite"
                  (favoriteChange)="onFavoriteChanged($event, report)"
                />
              </div>
              <span class="mt-1">Favorit</span>
            </div>
            <div class="flex flex-col items-center">
              <div class="bg-white w-[32px] h-[32px] md:w-[36px] md:h-[36px] rounded-full p-2 mb-1 flex items-center justify-center cursor-pointer" (click)="downloadSingleReportExcel()">
                <app-icon name="download" title="Excel Download" />
              </div>
              <span class="mt-1">Exportieren</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accordion sections -->
    <p-accordion multiple="true" [(value)]="activeAccordionValue" (onOpen)="onAccordionPanelOpen($event)">
      <!-- Details section -->
      <p-accordion-panel value="0">
        <p-accordion-header>
          <div class="flex items-center justify-between w-full">
            <span>Details</span>
            <div class="flex items-center gap-2 mr-4">
              <p-popover #detailsSettingsPopover>
                <div class="flex flex-col">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-sm">Feld-Einstellungen</span>
                    <button type="button" (click)="detailsSettingsPopover.hide(); $event.stopPropagation()"
                      class="text-gray-500 hover:text-gray-700 focus:outline-none cursor-pointer">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div class="space-y-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [(ngModel)]="showIsSpecCompliant" class="w-4 h-4" />
                      <span class="text-sm">Alles nach Vorgabe?</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" [(ngModel)]="showFeedback" class="w-4 h-4" />
                      <span class="text-sm">Feedback</span>
                    </label>
                  </div>
                </div>
              </p-popover>
              <span (click)="detailsSettingsPopover.toggle($event); $event.stopPropagation()" class="cursor-pointer text-primary-500 hover:text-primary-600">
                <span class="pi pi-cog text-sm"></span>
              </span>
            </div>
          </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="flex flex-col gap-y-4">
            <div *ngIf="report?.project?.questions" class="space-y-4">
              <div *ngFor="let question of report.project.questions">
                <div class="border border-gray-200 rounded-md p-3 min-h-[60px] bg-white">
                  <p class="text-[14px] text-gray-600 mb-1 font-bold">{{ question.questionText }}</p>
                  <ng-container *ngIf="question.answerType.name === 'text'">
                    <span class="text-[15px]">{{ getAnswerForQuestion(question.id)?.textAnswer || '-' }}</span>
                  </ng-container>
                  <ng-container *ngIf="question.answerType.name === 'boolean'">
                    <span class="text-[15px]">
                      {{ getAnswerForQuestion(question.id)?.textAnswer === 'true' ? 'Ja' : 'Nein' }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="question.answerType.name === 'select'">
                    <span class="text-[15px]">
                      {{ getAnswerForQuestion(question.id)?.selectedOption?.optionText || '-' }}
                    </span>
                  </ng-container>
                  <ng-container *ngIf="question.answerType.name === 'multiselect'">
                    <span class="text-[15px]">
                      {{ getMultiAnswersForQuestion(question.id) }}
                    </span>
                  </ng-container>
                </div>
              </div>
            </div>
            <!-- Alles nach Vorgabe field -->
            <div *ngIf="showIsSpecCompliant" class="border border-gray-200 rounded-md p-3 min-h-[60px] bg-white">
              <p class="text-[14px] text-gray-600 mb-1 font-bold">Alles nach Vorgabe?</p>
              <span class="text-[15px]">{{ report.isSpecCompliant ? 'Ja' : 'Nein' }}</span>
            </div>
            <!-- Feedback field -->
            <div *ngIf="showFeedback" class="border border-gray-200 rounded-md p-3 min-h-[60px] bg-white">
              <p class="text-[14px] text-gray-600 mb-1 font-bold">Feedback</p>
              <span class="text-[15px]">{{ report.feedback === true || report.feedback === 'true' ? 'Ja' : (report.feedback || '-') }}</span>
            </div>
          </div>
        </p-accordion-content>
      </p-accordion-panel>

      <!-- Photos section -->
      <p-accordion-panel value="1">
        <p-accordion-header>Fotos</p-accordion-header>
        <p-accordion-content>
          <p-galleria
            *ngIf="galleryImages && galleryImages.length > 0"
            #galleria
            [(value)]="galleryImages"
            [thumbnailsPosition]="position"
            [responsiveOptions]="responsiveOptions"
            [containerStyle]="{ 'max-width': '100%' }"
            [numVisible]="galleryImages.length > 4 ? 4 : galleryImages.length"
            [showItemNavigators]="false"
            [showThumbnailNavigators]="true"
            [circular]="true"
            [(activeIndex)]="selectedPhotoIndex"
            class="custom-galleria"
          >
            <!-- Main photo template -->
            <ng-template pTemplate="item" let-item>
              <div class="relative w-full">
                <!-- Label overlays for main photo -->
                <div class="absolute top-0 left-0 bg-white px-4 py-1 font-bold text-[14px] z-10 uppercase">
                  {{ item.beforeAfterType === 'before' ? 'VORHER' : 'NACHHER' }} {{ (item.title || '').split(',')[0] }}
                </div>
                <div class="absolute top-0 right-0 bg-white px-4 py-1 text-xs z-10 uppercase">{{ item.date | euDate }} | KW {{ item.date | date: 'w' }}</div>

                <!-- Main image -->
                <img [src]="item.itemImageSrc" [alt]="item.alt" class="w-full max-h-[685px] object-contain mt-8" />

                <!-- Navigation controls - positioned absolutely -->
                <div class="absolute top-1/2 left-4 transform -translate-y-1/2">
                  <button class="cursor-pointer" (click)="selectedPhotoIndex = selectedPhotoIndex === 0 ? galleryImages.length - 1 : selectedPhotoIndex - 1">
                    <app-icon name="arrow-left" class="w-5 h-5 text-gray-700" />
                  </button>
                </div>
                <div class="absolute top-1/2 right-4 transform -translate-y-1/2">
                  <button class="cursor-pointer" (click)="selectedPhotoIndex = selectedPhotoIndex === galleryImages.length - 1 ? 0 : selectedPhotoIndex + 1">
                    <app-icon name="arrow-right" class="w-5 h-5 text-gray-700" />
                  </button>
                </div>

                <!-- Bottom information bar -->
                <div class="absolute bottom-0 left-0 w-full bg-white bg-opacity-80 py-1 px-2 text-[13px] italic flex justify-between">
                  <span>{{ report.photoLocation }}</span>
                </div>
              </div>
            </ng-template>

            <!-- Thumbnail template -->
            <ng-template pTemplate="thumbnail" let-item let-i="index">
              <div class="relative overflow-hidden cursor-pointer w-[202px] h-[114px]" [class.border-primary-500]="selectedPhotoIndex === i" [class.shadow-selected]="selectedPhotoIndex === i">
                <img [src]="item.thumbnailImageSrc" [alt]="item.alt" class="w-full h-full object-cover" />
              </div>
              <div class="text-[10px] text-center py-0.5 truncate">
                {{ item.title }}
              </div>
            </ng-template>
          </p-galleria>

          <!-- No photos message -->
          <div *ngIf="!galleryImages || galleryImages.length === 0" class="text-center py-8">
            <p class="text-gray-500">Keine Fotos verfügbar</p>
          </div>

          <!-- Pagination indicators -->
          <div class="flex justify-center mt-4 gap-x-1" *ngIf="galleryImages && galleryImages.length > 0">
            <span
              *ngFor="let _ of galleryImages; let i = index"
              class="w-[17px] h-[17px] rounded-full cursor-pointer"
              [class.bg-primary-500]="i === selectedPhotoIndex"
              [ngClass]="{ 'border border-primary-500': i !== selectedPhotoIndex }"
              (click)="selectPhoto(i)"
            ></span>
          </div>
        </p-accordion-content>
      </p-accordion-panel>

      <!-- Dialog section -->
      <p-accordion-panel value="2">
        <p-accordion-header>Dialog</p-accordion-header>
        <p-accordion-content>
          <div class="flex flex-col gap-y-4">
            <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="lg:border-r border-gray-200 lg:pr-4 flex flex-col h-[400px]">
                <div class="flex-1 overflow-y-auto" #clientScrollContainer>
                  <div class="flex flex-col gap-y-4 p-2" *ngIf="report.clientMessages && report.clientMessages.length">
                    <ng-container *ngFor="let message of report.clientMessages; let i = index">
                      <div *ngIf="i === 0 || message.dateLabel !== report.clientMessages[i - 1]?.dateLabel" class="flex items-center py-2">
                        <div class="border-t border-gray-200 w-full"></div>
                        <span class="text-xs text-gray-500 px-8">{{ message.dateLabel }}</span>
                        <div class="border-t border-gray-200 w-full"></div>
                      </div>
                      <div class="flex" [class.justify-end]="message.sender !== 'client'">
                        <div class="flex items-end max-w-[80%]" [class.flex-row-reverse]="message.sender === 'client'">
                          <div *ngIf="message.sender === 'client'" class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img [src]="message.avatar" [alt]="message.senderName" class="w-full h-full object-cover" />
                          </div>
                          <div class="mx-2" [class.order-first]="message.sender === 'client'">
                            <span class="text-[13px] text-gray-500">{{ message.senderName }} {{ message.timeLabel }}</span>
                            <div
                              [ngClass]="{
                                'bg-[#464B58]': message.sender !== 'client',
                                'text-black': message.sender === 'client',
                                'text-white': message.sender !== 'client',
                                'bg-[#F2F2F2]': message.sender === 'client',
                              }"
                              class="rounded-lg p-4 mb-1 text-[14px]"
                            >
                              <p>{{ message.text }}</p>
                            </div>
                          </div>
                          <div *ngIf="message.sender !== 'client'" class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img [src]="message.avatar" [alt]="message.senderName" class="w-full h-full object-cover" />
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
                <div class="p-3 border-t border-gray-200 mt-auto">
                  <div class="flex gap-x-2">
                    <textarea
                      class="w-full border border-gray-300 rounded-[6px] p-2"
                      rows="1"
                      placeholder="Feedback von Agentur an Kunde"
                      [(ngModel)]="clientMessageContent"
                      [disabled]="sendingClientMessage"
                      (keydown.enter)="$event.preventDefault(); sendClientMessage()"
                    ></textarea>
                    <button
                      class="bg-primary-500 flex items-center justify-center text-white w-[49px] h-[47px] ml-2 rounded-[6px]"
                      (click)="sendClientMessage()"
                      [disabled]="sendingClientMessage || !clientMessageContent.trim()"
                    >
                      <div *ngIf="sendingClientMessage" class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2"></div>
                      <app-icon *ngIf="!sendingClientMessage" name="send" />
                    </button>
                  </div>
                </div>
              </div>
              <div class="flex flex-col h-[400px]">
                <div class="flex-1 overflow-y-auto" #merchandiserScrollContainer>
                  <div class="flex flex-col gap-y-4 p-2" *ngIf="report.merchandiserMessages && report.merchandiserMessages.length">
                    <ng-container *ngFor="let message of report.merchandiserMessages; let i = index">
                      <div *ngIf="i === 0 || message.dateLabel !== report.merchandiserMessages[i - 1]?.dateLabel" class="flex items-center py-2">
                        <div class="border-t border-gray-200 w-full"></div>
                        <span class="text-xs text-gray-500 px-8">{{ message.dateLabel }}</span>
                        <div class="border-t border-gray-200 w-full"></div>
                      </div>
                      <div class="flex" [class.justify-end]="message.sender !== 'merchandiser'">
                        <div class="flex items-end max-w-[80%]" [class.flex-row-reverse]="message.sender === 'merchandiser'">
                          <div *ngIf="message.sender === 'merchandiser'" class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img [src]="message.avatar" [alt]="message.senderName" class="w-full h-full object-cover" />
                          </div>
                          <div class="mx-2" [class.order-first]="message.sender === 'merchandiser'">
                            <span class="text-[13px] text-gray-500">{{ message.senderName }} {{ message.timeLabel }}</span>
                            <div
                              [ngClass]="{
                                'bg-[#464B58]': message.sender !== 'merchandiser',
                                'text-black': message.sender === 'merchandiser',
                                'text-white': message.sender !== 'merchandiser',
                                'bg-[#F2F2F2]': message.sender === 'merchandiser',
                              }"
                              class="rounded-lg p-4 mb-1 text-[14px]"
                            >
                              <p>{{ message.text }}</p>
                            </div>
                          </div>
                          <div *ngIf="message.sender !== 'merchandiser'" class="w-10 h-10 rounded-full overflow-hidden flex-shrink-0">
                            <img [src]="message.avatar" [alt]="message.senderName" class="w-full h-full object-cover" />
                          </div>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </div>
                <div class="p-3 border-t border-gray-200 mt-auto">
                  <div class="flex gap-x-2">
                    <textarea
                      class="w-full border border-gray-300 rounded-[6px] p-2"
                      rows="1"
                      placeholder="Feedback von Agentur an VM"
                      [(ngModel)]="merchandiserMessageContent"
                      [disabled]="sendingMerchandiserMessage"
                      (keydown.enter)="$event.preventDefault(); sendMerchandiserMessage()"
                    ></textarea>
                    <button
                      class="bg-primary-500 flex items-center justify-center text-white w-[49px] h-[47px] ml-2 rounded-[6px]"
                      (click)="sendMerchandiserMessage()"
                      [disabled]="sendingMerchandiserMessage || !merchandiserMessageContent.trim()"
                    >
                      <div *ngIf="sendingMerchandiserMessage" class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2"></div>
                      <app-icon *ngIf="!sendingMerchandiserMessage" name="send" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-accordion-content>
      </p-accordion-panel>
    </p-accordion>
  </div>
</section>

<!-- CSV/Excel Download Success/Error Dialog -->
<p-dialog
  [(visible)]="csvDialogVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '329px' }"
  [contentStyle]="{ padding: '2rem', borderRadius: '8px', textAlign: 'center' }"
  [showHeader]="false"
  [closeOnEscape]="true"
  [dismissableMask]="true"
>
  <div class="flex flex-col items-center">
    <div
      class="w-[71px] h-[71px] rounded-full flex items-center justify-center mb-6"
      [ngStyle]="{
        border: csvDialogIsError ? '2px solid #D10003' : '2px solid #007296',
        background: csvDialogIsError ? '#FFEFF0' : '#EFF6FF',
      }"
    >
      <app-icon *ngIf="!csvDialogIsError" name="modal-check" class="" />
      <app-icon *ngIf="csvDialogIsError" name="cross" class="text-[#D10003] w-[25px] h-[25px]" />
    </div>

    <h2 class="text-[14px] font-medium mb-4" [ngClass]="csvDialogIsError ? 'text-[#D10003]' : ''">
      {{ dialogMessage }}
    </h2>

    <hr class="w-full border-t border-gray-200 mb-4" />

    <button
      (click)="csvDialogVisible = false"
      [ngClass]="csvDialogIsError ? 'bg-[#D10003] hover:bg-[#D10003]' : 'bg-[#007296] hover:bg-[#005d7a]'"
      class="text-white text-[14px] rounded-md transition-colors flex items-center justify-center gap-2 w-[183px] h-[37px]"
    >
      <span>OK</span>
    </button>
  </div>
</p-dialog>
